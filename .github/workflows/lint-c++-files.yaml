# Summary: TFQ continuous integration workflow for checking C++ files.
#
# This workflow runs clang-formmat. It only examines C++ and protobuf files.
# It can be invoked manually using the "Run workflow" button on the page at
# https://github.com/tensorflow/quantum/actions/workflows/lint-c++-files.yaml
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

name: C++ & protobuf file checks
run-name: >
  C++ & protobuf lint & format checks for ${{github.event_name}}
  by ${{github.triggering_actor}}

env:
  # Version of clang-format to use. Can be overridden with workflow_dispatch.
  # Note: as of 2025-01-14, v. 18 is the latest available on Ubuntu 24.04.
  clang_format_ver: '18'

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.cc'
      - '**.h'
      - '**.proto'

  push:
    branches:
      - main
    paths:
      - '**.cc'
      - '**.h'
      - '**.proto'

  # For manual invocation, with options that might be useful for debugging.
  workflow_dispatch:
    inputs:
      files:
        description: "Files and/or directories to check:"
        type: string
      clang_format_ver:
        description: 'clang-format version:'
        type: string

# Cancel previously-started but still active workflow runs on the same branch.
concurrency:
  group: ${{github.workflow}}-${{github.event.pull_request.number||github.ref}}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  format:
    name: Check the format of C++ and Protobuf files
    runs-on: ubuntu-24.04
    steps:
      - name: Check out a copy of the TFQ git repository
        uses: actions/checkout@v4

      - if: github.event_name != 'workflow_dispatch'
        name: Get the list of C++ & Protobuf files changed in the triggering event
        id: changes
        uses: tj-actions/changed-files@v45
        # Although this workflow is triggered only if C++ & Protobuf files are
        # changed, they might not be the *only* files changed; hence, we have
        # to filter the set of files down to just the C++/Protobuf files.
        with:
          files: |
            **.cc
            **.h
            **.proto

      - name: Determine the files to be checked
        id: files
        run: |
          # Files/dirs given during manual invocation take precedence.
          if [[ "${{github.event_name}}" == "workflow_dispatch" ]]; then
            if [[ -n "${{inputs.files}}" ]]; then
              files="${{inputs.files}}"
            else
              echo "::error title=Error::No file names or directories provided."
              exit 1
            fi
          else
            files="${{steps.changes.outputs.all_changed_files}}"
          fi
          echo "files_to_check='$files'" >> "$GITHUB_OUTPUT"

      - name: Run clang-format on C++ and Protobuf files
        run: |
          version="${{inputs.clang_format_ver || env.clang_format_ver}}"
          git clang-format-$version --style google --diff ${{github.event.before}}
